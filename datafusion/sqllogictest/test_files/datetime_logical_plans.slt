##########
## test when server time is not UTC
#
# In the cases where ordering matters, the cast to server tz must be applied before the datetime fun
##########

statement ok
set timezone to '+07';

# Conclusion: ordering doesn't matter
# start => add tz => trunc => cast to server tz
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01+07' => '2000-01-01T01:00:00+07' => same
# start => add tz => cast to server tz => trunc
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01+07' => same => '2000-01-01T00:00:00+07'
# postgresql: 2000-01-01 01:00:00+07
query P
SELECT date_trunc('hour', TIMESTAMPTZ '2000-01-01T01:01:01') as ts
----
1999-12-31T18:00:00

# Conclusion: ordering doesn't matter
# start => add tz => trunc => cast to server tz
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01+07' => '2000-01-01T00:00:00+07' => same
# start => add tz => cast to server tz => trunc
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01+07' => same => '2000-01-01T00:00:00+07'
# postgresql: 2000-01-01 00:00:00+07
query P
SELECT date_trunc('day', TIMESTAMPTZ '2000-01-01T01:01:01') as ts
----
1999-12-31T00:00:00

# Conclusion: ordering doesn't matter
# start => trunc => cast to server tz
# '2000-01-01T01:01:01Z' => '2000-01-01T01:00:00Z' => '2000-01-01T08:00:00+07'
# start => cast to server tz => trunc
# '2000-01-01T01:01:01Z' => '2000-01-01T08:01:01+07' => '2000-01-01T08:00:00+07'
# postgresql: 2000-01-01 08:00:00+07
query P
SELECT date_trunc('hour', TIMESTAMPTZ '2000-01-01T01:01:01Z') as ts
----
2000-01-01T01:00:00

# Conclusion: ordering matters
# start => trunc => cast to server tz
# '2000-01-01T01:01:01Z' => '2000-01-01T00:00:00Z' => '2000-01-01T07:00:00+07' => wrong
# start => cast to server tz => trunc
# '2000-01-01T01:01:01Z' => '2000-01-01T08:01:01+07' => '2000-01-01T00:00:00+07' => correct
# postgresql: 2000-01-01 00:00:00+07
query P
SELECT date_trunc('day', TIMESTAMPTZ '2000-01-01T01:01:01Z') as ts
----
2000-01-01T00:00:00

# Conclusion: ordering doesn't matter
# start => add tz => date_bin => cast to server tz
# '2022-01-01 20:10:00' => '2022-01-01 20:10:00+07' => '2022-01-01 00:00:00+07' => same
# start => add tz => cast to server tz => date_bin
# '2022-01-01 20:10:00' => '2022-01-01 20:10:00+07' => same => '2022-01-01 00:00:00+07
# postgresql:  2022-01-01 00:00:00+07
query P
SELECT date_bin('1 day', TIMESTAMPTZ '2022-01-01 20:10:00', TIMESTAMPTZ '2020-01-01')
----
2021-12-31T17:00:00

# Conclusion: ordering matters
# start => date_bin => cast to server tz
# '2022-01-01 20:10:00Z' => '2022-01-01 00:00:00Z' => '2022-01-01 07:00:00+07' => wrong
# start => cast to server tz => date_bin
# '2022-01-01 15:10:00Z' => '2022-01-02T03:10:00+07' => '2022-01-02T00:00:00+07' => correct
# postgresql: 2022-01-02 00:00:00+07
query P
SELECT date_bin('1 day', TIMESTAMPTZ '2022-01-01 20:10:00Z', TIMESTAMPTZ '2020-01-01')
----
2022-01-01T17:00:00

# Conclusion: ordering doesn't matter
# start => add tz => date_part => cast to server tz
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01+07' => 1 => same
# start => add tz => cast to server tz => date_part
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01+07' => 1 => correct
# postgresql: 1 
query R
SELECT date_part('hour', TIMESTAMPTZ '2000-01-01T01:01:01') as part
----
18

# Conclusion: ordering doesn't matter
# start => date_part => cast to server tz
# '2000-01-01T01:01:01Z' => 1 => 8
# start => cast to server tz => date_part
# '2000-01-01T01:01:01Z' => '2000-01-01T08:01:01+07' => 8
# postgresql: 8 
query R
SELECT date_part('hour', TIMESTAMPTZ '2000-01-01T01:01:01Z') as part
----
1



##########
## test when server time is UTC
#
# In the cases where ordering matters, the cast to server tz must be applied before the datetime fun
##########

statement ok
set timezone to '+00';

# Conclusion: ordering doesn't matter
# start => add tz => trunc => cast to server tz
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01Z' => '2000-01-01T01:00:00Z' => same
# start => add tz => cast to server tz => trunc
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01Z' => same => '2000-01-01T01:00:00Z'
# postgresql: 2000-01-01T01:00:00+00
query P
SELECT date_trunc('hour', TIMESTAMPTZ '2000-01-01T01:01:01') as ts
----
2000-01-01T01:00:00

# Conclusion: ordering doesn't matter
# start => add tz => trunc => cast to server tz
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01Z' => '2000-01-01T00:00:00Z' => same
# start => add tz => cast to server tz => trunc
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01Z' => same => '2000-01-01T00:00:00Z'
# postgresql: 2000-01-01T00:00:00+00
query P
SELECT date_trunc('day', TIMESTAMPTZ '2000-01-01T01:01:01') as ts
----
2000-01-01T00:00:00

# Conclusion: ordering doesn't matter
# start => trunc => cast to server tz
# '2000-01-01T01:01:01+07 => '2000-01-01T01:00:00+07' => '1999-12-31T18:00:00Z'
# start => cast to server tz => trunc
# '2000-01-01T01:01:01+07 => '1999-12-31T18:01:01+00' => '1999-12-31T18:00:00Z'
# postgresql: 1999-12-31T18:00:00+00
query P
SELECT date_trunc('hour', TIMESTAMPTZ '2000-01-01T01:01:01+07') as ts
----
1999-12-31T18:00:00

# Conclusion: ordering matters
# start => trunc => cast to server tz
# '2000-01-01T01:01:01+07' => '2000-01-01T00:00:00+07' => '1999-12-31T17:00:00+00' => wrong
# start => cast to server tz => trunc
# '2000-01-01T01:01:01+07' => '1999-12-31 18:01:01+00' => '1999-12-31T00:00:00+00' => correct
# postgresql: 1999-12-31T00:00:00+00
query P
SELECT date_trunc('day', TIMESTAMPTZ '2000-01-01T01:01:01+07') as ts
----
1999-12-31T00:00:00

# Conclusion: ordering doesn't matter
# start => add tz => date_bin => cast to server tz
# '2022-01-01 20:10:00' => '2022-01-01 20:10:00Z' => '2022-01-01T00:00:00+00' => same
# start => add tz => cast to server tz => date_bin
# '2022-01-01 20:10:00' => '2022-01-01 20:10:00Z' => same => '2022-01-01T00:00:00+00'
# postgresql: 2022-01-01 00:00:00+00
query P
SELECT date_bin('1 day', TIMESTAMPTZ '2022-01-01 20:10:00', TIMESTAMPTZ '2020-01-01')
----
2022-01-01T00:00:00

# Conclusion: ordering matters
# start => date_bin => cast to server tz
# '2022-01-01 01:10:00+07' => '2022-01-01 00:00:00+07' => '2021-12-31T17:00:00Z' => wrong
# start => cast to server tz => date_bin
# '2022-01-01 01:10:00+07' => '2021-12-31T18:10:00Z' => '2021-12-31T00:00:00Z' => correct
# postgresql: 2021-12-31 00:00:00+00
query P
SELECT date_bin('1 day', TIMESTAMPTZ '2022-01-01 01:10:00+07', TIMESTAMPTZ '2020-01-01')
----
2021-12-31T00:00:00

# Conclusion: ordering doesn't matter
# start => add tz => date_part => cast to server tz
# '2000-01-01T01:01:01' => '2000-01-01T01:01:01Z' => 1 => same
# start => add tz => cast to server tz => date_part
# ''2000-01-01T01:01:01' => '2000-01-01T01:01:01Z' => same => 1
# postgresql: 1
query R
SELECT date_part('hour', TIMESTAMPTZ '2000-01-01T01:01:01') as part
----
1

# Conclusion: ordering doesn't matter
# start => date_part => cast to server tz
# '2000-01-01T01:01:01+07' => 1 => 18
# start => cast to server tz => date_part
# '2000-01-01T01:01:01+07' => '1999-12-31 18:01:01+00' => 18
# postgresql: 18
query R
SELECT date_part('hour', TIMESTAMPTZ '2000-01-01T01:01:01+07') as part
----
18
